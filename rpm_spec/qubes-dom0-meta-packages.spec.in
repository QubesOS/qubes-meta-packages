Name:		qubes-dom0-meta-packages
Version:	@VERSION@
Release:	1%{?dist}
Summary:	Meta packages for Qubes-specific components
BuildArch:  noarch

Group:		System Environment/Base
License:	GPLv2+
URL:		https://www.qubes-os.org/

Conflicts:  qubes-release < 4.1-0.26
Source0: %{name}-%{version}.tar.gz

BuildRequires: make

%description
Meta packages for easy maintenance of installed Qubes OS specific packages.

%package -n qubes-repo-contrib
Summary: Repository definition for packages contributed to Qubes OS

%description -n qubes-repo-contrib
Contrib repository contains packages written/adopted specifically for Qubes,
not available in upstream repositories.

%package -n qubes-repo-devel
Summary:    Qubes devel packages repository

%description -n qubes-repo-devel
Qubes devel packages repository. Packages built from the main branch directly,
not official releases, no any guarantee, no security support. Use at your
own risk.

%package -n qubes-dom0-unwanted-packages
Summary: Prevents installing unwanted dom0 packages
# gtk3 Recommends: tracker-miner, avoid installing the whole thing
Conflicts: tracker

%description -n qubes-dom0-unwanted-packages
Conflicts or dummy provides packages that are not wanted in dom0.

%prep
%setup -q

%build

%install
# contrib repo
make -C repos install-dom0 DESTDIR=$RPM_BUILD_ROOT

%files

%files -n qubes-repo-contrib
%config(noreplace) /etc/yum.repos.d/qubes-contrib-dom0-r4.3.repo
/etc/pki/rpm-gpg/RPM-GPG-KEY-qubes-4.3-contrib-host

%files -n qubes-repo-devel
%config(noreplace) /etc/yum.repos.d/qubes-devel-host.repo
/etc/pki/rpm-gpg/RPM-GPG-KEY-qubes-devel-primary

%files -n qubes-dom0-unwanted-packages

%postun -n qubes-repo-contrib
if [ $1 -eq 0 ] ; then
    systemd-run --timer-property=AccuracySec=1s --on-active=5s timeout 15m \
     bash -c "while ! rpm -e gpg-pubkey-d68eea26-693c1ec5; do sleep 5; done" || :
fi

%posttrans -n qubes-repo-contrib
systemd-run --timer-property=AccuracySec=1s --on-active=5s timeout 15m bash -c \
 "while ! rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-qubes-4.3-contrib-host; do \
  sleep 5; done; \
  while rpm -q gpg-pubkey-d0941e87-5d8c9210 && \
    ! rpm -e gpg-pubkey-d0941e87-5d8c9210; do sleep 5; done" || :

%postun -n qubes-repo-devel
if [ $1 -eq 0 ] ; then
    systemd-run --timer-property=AccuracySec=1s --on-active=5s timeout 15m \
     bash -c "while ! rpm -e gpg-pubkey-1cbe626c-6942a63f; do sleep 5; done" || :
fi

%posttrans -n qubes-repo-devel
systemd-run --timer-property=AccuracySec=1s --on-active=5s timeout 15m bash -c \
 "while ! rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-qubes-devel-primary; do \
  sleep 5; done" || :
%changelog
@CHANGELOG@
